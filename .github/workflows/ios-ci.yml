name: iOS CI

on:
  push:
    branches: [main]
    paths:
      - 'ios/**'
      - 'opaque-swift/**'
      - '.github/workflows/ios-ci.yml'
      - '.swiftlint.yml'
      - '.swiftformat'
  pull_request:
    branches: [main]
    paths:
      - 'ios/**'
      - 'opaque-swift/**'
      - '.github/workflows/ios-ci.yml'
      - '.swiftlint.yml'
      - '.swiftformat'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: macos-26
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - run: brew install swiftlint
      - run: |
          cd ios/FamilyMedicalApp
          swiftlint lint --config ../../.swiftlint.yml --strict --reporter github-actions-logging

  format-check:
    name: Format Check
    runs-on: macos-26
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - run: brew install swiftformat
      - run: swiftformat --config .swiftformat --lint ios/FamilyMedicalApp/FamilyMedicalApp

  xcframework:
    name: Build XCFramework
    runs-on: macos-26
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Get Xcode version
        id: xcode-version
        run: |
          xcodebuild -version
          swift --version
          echo "version=$(xcodebuild -version | awk 'NR==1 {print $2}')" >> "$GITHUB_OUTPUT"

      - name: Restore XCFramework cache
        id: cache
        uses: actions/cache@v5
        with:
          path: |
            opaque-swift/OpaqueSwift.xcframework
            opaque-swift/generated
            opaque-swift/Sources
          key: ${{ runner.os }}-xcframework-xcode${{ steps.xcode-version.outputs.version }}-${{ hashFiles('opaque-swift/src/lib.rs', 'opaque-swift/Cargo.toml', 'opaque-swift/build-xcframework.sh', 'opaque-swift/uniffi-bindgen.rs') }}

      - name: Install Rust toolchain
        if: steps.cache.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Cache Rust dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: opaque-swift

      - name: Build XCFramework
        if: steps.cache.outputs.cache-hit != 'true'
        run: cd opaque-swift && chmod +x build-xcframework.sh && ./build-xcframework.sh

      - name: Upload XCFramework artifact
        uses: actions/upload-artifact@v6
        with:
          name: OpaqueSwift-xcframework
          path: |
            opaque-swift/OpaqueSwift.xcframework
            opaque-swift/generated
            opaque-swift/Sources
          retention-days: 1

  build:
    name: Build & Test (${{ matrix.device }})
    needs: [xcframework]
    runs-on: macos-26
    timeout-minutes: 35
    strategy:
      matrix:
        include:
          - device: iPhone
            destination: platform=iOS Simulator,name=iPhone 17 Pro
          - device: iPad
            destination: platform=iOS Simulator,name=iPad Pro 13-inch (M5)
    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Get Xcode version
        id: xcode-version
        run: |
          xcodebuild -version
          swift --version
          echo "version=$(xcodebuild -version | awk 'NR==1 {print $2}')" >> "$GITHUB_OUTPUT"

      - name: Download XCFramework
        uses: actions/download-artifact@v5
        with:
          name: OpaqueSwift-xcframework
          path: opaque-swift

      - name: List available simulators (debug)
        run: xcrun simctl list devices available | head -50

      - name: Restore DerivedData cache
        uses: actions/cache/restore@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-xcode${{ steps.xcode-version.outputs.version }}-${{ matrix.device }}-${{ hashFiles('ios/**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-xcode${{ steps.xcode-version.outputs.version }}-${{ matrix.device }}-
            ${{ runner.os }}-deriveddata-xcode${{ steps.xcode-version.outputs.version }}-

      - name: Build
        run: |
          set -o pipefail
          cd ios/FamilyMedicalApp
          xcodebuild build \
            -project FamilyMedicalApp.xcodeproj \
            -scheme FamilyMedicalApp \
            -destination "${{ matrix.destination }}" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty

      - name: Save DerivedData cache
        uses: actions/cache/save@v5
        if: always()
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-xcode${{ steps.xcode-version.outputs.version }}-${{ matrix.device }}-${{ hashFiles('ios/**/*.swift') }}

      - name: Disable CPU-intensive services
        run: |
          sudo launchctl bootout system/com.apple.PerfPowerServices 2>/dev/null || true
          sudo launchctl bootout system/com.apple.metadata.mds 2>/dev/null || true

      - name: Run Tests
        run: ./scripts/run-tests.sh --destination "${{ matrix.destination }}"

      - name: Generate coverage JSON
        if: matrix.device == 'iPhone'
        run: |
          cd ios/FamilyMedicalApp
          xcrun xccov view --report --json test-results/TestResults.xcresult > test-results/coverage.json

      - name: Upload coverage reports
        if: matrix.device == 'iPhone'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: ios/FamilyMedicalApp/test-results/coverage.json
          retention-days: 30

      - name: Check coverage thresholds
        if: matrix.device == 'iPhone'
        run: ./scripts/check-coverage.sh

  security-scan:
    name: Security Scan
    runs-on: macos-26
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Run SwiftLint security rules
        run: |
          brew install swiftlint
          cd ios/FamilyMedicalApp
          swiftlint lint --config ../../.swiftlint.yml --strict --reporter json > swiftlint-results.json || true

          SECURITY_ISSUES=$(cat swiftlint-results.json | python3 -c "
          import sys, json
          results = json.load(sys.stdin)
          security_rules = ['no_force_try_crypto', 'password_in_code', 'primary_key_logging']
          count = sum(1 for r in results if r.get('rule_id') in security_rules)
          print(count)
          ")

          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "❌ Found $SECURITY_ISSUES security-related violations"
            cat swiftlint-results.json | python3 -c "
            import sys, json
            results = json.load(sys.stdin)
            security_rules = ['no_force_try_crypto', 'password_in_code', 'primary_key_logging']
            for r in results:
              if r.get('rule_id') in security_rules:
                print(f\"⚠️  {r['file']}:{r['line']} - {r['reason']}\")
            "
            exit 1
          fi

      - name: Check for sensitive files
        run: |
          SENSITIVE_FILES=$(find . -type f \( -name "*.p12" -o -name "*.mobileprovision" -o -name "*_key.pem" -o -name "*.keystore" \) | grep -v ".git" || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "❌ Found sensitive files in repository:"
            echo "$SENSITIVE_FILES"
            exit 1
          fi
          echo "✅ No sensitive files found"

  summary:
    name: CI Summary
    needs: [lint, format-check, build, security-scan]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Linting failed"
            exit 1
          fi
          if [ "${{ needs.format-check.result }}" != "success" ]; then
            echo "❌ Format check failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ Build/Tests failed"
            exit 1
          fi
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Security scan failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
