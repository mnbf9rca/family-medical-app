name: Backend Rust Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Delete Preview Worker
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Install Wrangler v4
        run: npm install -g wrangler@4

      - name: Delete PR worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          WORKER_NAME="recordwell-opaque-pr-${PR_NUMBER}-preview"
          OUTPUT=$(wrangler delete --name "$WORKER_NAME" --force 2>&1) && EXIT_CODE=0 || EXIT_CODE=$?
          echo "$OUTPUT"

          # Allow "worker doesn't exist" (PR closed before deployment)
          # Fail on real errors (auth, network, etc.)
          if [ "$EXIT_CODE" -ne 0 ]; then
            if echo "$OUTPUT" | grep -q "does not exist"; then
              echo "Worker $WORKER_NAME doesn't exist (may not have been deployed) - OK"
              exit 0
            else
              echo "Failed to delete worker $WORKER_NAME"
              exit "$EXIT_CODE"
            fi
          fi
          echo "Successfully deleted worker $WORKER_NAME"
